<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>GoQik Atlas · 标准演化报告中心</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", system-ui, sans-serif;
      background: #020817;
      color: #e2e8f0;
    }
    a { color: inherit; text-decoration: none; }

    .page {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .header {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 16px 24px;
      border-bottom: 1px solid #1e293b;
      background: radial-gradient(circle at top left, #0f172a, #020617);
    }
    .logo-pill {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 14px;
      border-radius: 999px;
      background: #0f172a;
      border: 1px solid #1e293b;
      font-weight: 600;
      font-size: 18px;
    }
    .logo-dot {
      width: 10px;
      height: 10px;
      border-radius: 999px;
      background: #38bdf8;
      box-shadow: 0 0 12px rgba(56,189,248,.8);
    }
    .header-title {
      font-size: 18px;
      color: #e5e7eb;
    }

    .tabs {
      margin-left: auto;
      display: flex;
      gap: 8px;
      font-size: 13px;
      border-radius: 999px;
      padding: 4px;
      background: rgba(15,23,42,.85);
      border: 1px solid #1f2937;
    }
    .tab {
      padding: 4px 10px;
      border-radius: 999px;
      color: #94a3b8;
    }
    .tab--active {
      background: #0ea5e9;
      color: #0b1120;
      font-weight: 600;
    }

    .main {
      flex: 1;
      display: grid;
      grid-template-columns: 280px minmax(0, 1fr);
      gap: 24px;
      padding: 20px 24px 32px;
    }

    .sidebar {
      border-radius: 18px;
      border: 1px solid #1e293b;
      background: radial-gradient(circle at top left, rgba(15,23,42,.9), rgba(15,23,42,.7));
      padding: 18px 18px 22px;
    }
    .sidebar-title {
      font-size: 15px;
      font-weight: 600;
      margin-bottom: 12px;
    }
    .field {
      margin-bottom: 14px;
    }
    .field-label {
      font-size: 12px;
      color: #9ca3af;
      margin-bottom: 4px;
    }
    .input, .select {
      width: 100%;
      padding: 7px 10px;
      border-radius: 999px;
      border: 1px solid #1f2937;
      background: #020617;
      color: #e5e7eb;
      font-size: 13px;
      outline: none;
    }
    .input:focus, .select:focus {
      border-color: #0ea5e9;
      box-shadow: 0 0 0 1px rgba(14,165,233,.4);
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      padding: 7px 18px;
      border-radius: 999px;
      border: 0;
      font-size: 13px;
      cursor: pointer;
      transition: transform .08s ease, box-shadow .08s ease, background .08s ease;
      white-space: nowrap;
    }
    .btn-primary {
      background: linear-gradient(135deg, #0ea5e9, #22c55e);
      color: #0b1120;
      font-weight: 600;
      width: 100%;
      margin-top: 6px;
    }
    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 10px 25px rgba(59,130,246,.35);
    }

    .sidebar-footer {
      margin-top: 16px;
      padding-top: 10px;
      border-top: 1px dashed #1f2937;
      font-size: 12px;
      color: #9ca3af;
      line-height: 1.5;
    }
    .sidebar-footer strong { color: #e5e7eb; }

    .content {
      border-radius: 18px;
      border: 1px solid #1e293b;
      background: radial-gradient(circle at top right, rgba(15,23,42,.95), rgba(15,23,42,.8));
      padding: 18px 18px 24px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .content-header {
      display: flex;
      align-items: flex-end;
      justify-content: space-between;
      gap: 12px;
    }
    .content-title {
      font-size: 18px;
      font-weight: 600;
    }
    .content-sub {
      font-size: 12px;
      color: #9ca3af;
      margin-top: 2px;
    }

    .tag-pill {
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid #1e293b;
      color: #9ca3af;
    }

    .list {
      margin-top: 10px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .card {
      border-radius: 16px;
      border: 1px solid #1e293b;
      background: radial-gradient(circle at top left, #020617, #020617);
      padding: 14px 16px 12px;
      display: grid;
      grid-template-columns: minmax(0, 1.2fr) minmax(0, 1.4fr) auto;
      gap: 12px;
      align-items: center;
    }

    .card-title {
      font-size: 15px;
      font-weight: 600;
      margin-bottom: 4px;
    }
    .card-meta {
      font-size: 12px;
      color: #9ca3af;
      line-height: 1.5;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 11px;
      border: 1px solid #1f2937;
      margin-right: 4px;
    }
    .badge-label {
      color: #9ca3af;
      margin-right: 2px;
    }
    .badge-fail {
      color: #fecaca;
      border-color: rgba(248,113,113,.4);
      background: rgba(127,29,29,.35);
    }
    .badge-pass {
      color: #bbf7d0;
      border-color: rgba(34,197,94,.45);
      background: rgba(22,101,52,.5);
    }

    .score-text {
      font-weight: 600;
    }
    .score-text--warn { color: #f97316; }
    .score-text--ok   { color: #22c55e; }

    .card-links {
      font-size: 11px;
      color: #9ca3af;
      line-height: 1.6;
    }
    .card-links span {
      display: inline-block;
      margin-right: 12px;
    }

    .card-actions {
      display: flex;
      flex-direction: column;
      gap: 6px;
      justify-content: center;
      align-items: flex-end;
    }
    .btn-secondary {
      background: #020617;
      color: #e5e7eb;
      border: 1px solid #1f2937;
      padding-inline: 14px;
    }
    .btn-secondary:hover {
      background: #0f172a;
      transform: translateY(-1px);
      box-shadow: 0 8px 20px rgba(15,23,42,.7);
    }
    .btn-ghost {
      background: transparent;
      color: #93c5fd;
      border: 0;
      padding-inline: 10px;
    }
    .btn-ghost:hover {
      background: rgba(30,64,175,.4);
      transform: translateY(-1px);
    }

    .empty {
      padding: 36px 12px;
      text-align: center;
      font-size: 13px;
      color: #9ca3af;
    }

    /* Modal */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(15,23,42,0.9);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 50;
    }
    .modal-backdrop.modal--open {
      display: flex;
    }
    .modal {
      width: min(1000px, 96vw);
      height: min(640px, 90vh);
      background: #020617;
      border-radius: 18px;
      border: 1px solid #1e293b;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    .modal-header {
      padding: 10px 14px;
      border-bottom: 1px solid #1e293b;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }
    .modal-title {
      font-size: 14px;
      font-weight: 600;
    }
    .modal-sub {
      font-size: 11px;
      color: #9ca3af;
      margin-top: 2px;
    }
    .modal-close {
      border-radius: 999px;
      border: 1px solid #1f2937;
      background: #020617;
      color: #e5e7eb;
      width: 30px;
      height: 30px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 18px;
    }
    .modal-close:hover {
      background: #0f172a;
    }
    .modal-body {
      flex: 1;
      padding: 0;
      background: #0b1120;
    }
    .modal-iframe {
      width: 100%;
      height: 100%;
      border: none;
      background: #ffffff;
    }

    @media (max-width: 960px) {
      .main {
        grid-template-columns: minmax(0, 1fr);
      }
      .card {
        grid-template-columns: minmax(0, 1fr);
        align-items: flex-start;
      }
      .card-actions {
        flex-direction: row;
        justify-content: flex-start;
      }
    }
  </style>
</head>
<body>
<div class="page">
  <header class="header">
    <div class="logo-pill">
      <span class="logo-dot"></span>
      <span>GoQik Atlas</span>
    </div>
    <div class="header-title">标准演化报告中心</div>

    <div class="tabs">
      <div class="tab tab--active">B-layer QSPEC · Law · QEVR · Gate</div>
    </div>
  </header>

  <main class="main">
    <aside class="sidebar">
      <div class="sidebar-title">过滤器</div>

      <div class="field">
        <div class="field-label">域 / 标准：</div>
        <input id="filter-domain" class="input" placeholder="例如：SS.LAW.NAMR" />
      </div>

      <div class="field">
        <div class="field-label">Gate 状态：</div>
        <select id="filter-gate" class="select">
          <option value="all">全部</option>
          <option value="pass">已通过</option>
          <option value="fail">未通过</option>
        </select>
      </div>

      <div class="field">
        <div class="field-label">最小得分：</div>
        <input id="filter-min-score" class="input" value="0.90" />
      </div>

      <button id="btn-apply-filter" class="btn btn-primary">
        重置过滤
      </button>

      <div class="sidebar-footer">
        本页面仅展示 <strong>机读规则演化结果</strong> 的摘要。
        具体细节请点击记录右侧的「查看 HTML 报告」。
      </div>
    </aside>

    <section class="content">
      <div class="content-header">
        <div>
          <div class="content-title">演化版本一览</div>
          <div class="content-sub">
            <span id="summary-count">共 0 条演化记录</span>
          </div>
        </div>
        <div class="tag-pill">B-layer 自演化 · 只读观测</div>
      </div>

      <div id="report-list" class="list">
        <div class="empty">正在加载报告列表...</div>
      </div>
    </section>
  </main>
</div>

<!-- 报告预览 Modal -->
<div id="report-modal-backdrop" class="modal-backdrop">
  <div class="modal">
    <div class="modal-header">
      <div>
        <div id="modal-title" class="modal-title">HTML 报告预览</div>
        <div id="modal-sub" class="modal-sub"></div>
      </div>
      <button id="modal-close" class="modal-close">&times;</button>
    </div>
    <div class="modal-body">
      <iframe id="report-iframe" class="modal-iframe" src="about:blank"></iframe>
    </div>
  </div>
</div>

<script>
  const state = {
    allReports: [],
    filtered: []
  };

  function badgeGate(report) {
    const pass = report.gate_status === 'pass';
    const cls = pass ? 'badge badge-pass' : 'badge badge-fail';
    const label = pass ? '已通过' : '未通过';
    return { cls, label };
  }

  function scoreClass(report) {
    if (!report.overall_score) return '';
    return report.overall_score >= (report.threshold || 0.9)
      ? 'score-text score-text--ok'
      : 'score-text score-text--warn';
  }

  function formatScore(report) {
    if (typeof report.overall_score !== 'number') return '—';
    const thr = typeof report.threshold === 'number' ? report.threshold.toFixed(2) : '—';
    return `${report.overall_score.toFixed(2)} / ${thr}`;
  }

  function formatTime(ts) {
    if (!ts) return '—';
    try {
      const d = new Date(ts);
      return d.toISOString().slice(0,19).replace('T',' ');
    } catch {
      return ts;
    }
  }

  function renderList() {
    const list = document.getElementById('report-list');
    list.innerHTML = '';

    if (!state.filtered.length) {
      list.innerHTML = '<div class="empty">没有符合条件的演化记录。</div>';
      document.getElementById('summary-count').textContent = '共 0 条演化记录';
      return;
    }

    document.getElementById('summary-count').textContent =
      '共 ' + state.filtered.length + ' 条演化记录';

    state.filtered.forEach((r) => {
      const card = document.createElement('div');
      card.className = 'card';

      const left = document.createElement('div');
      left.innerHTML = `
        <div class="card-title">${r.title || r.id}</div>
        <div class="card-meta">
          域：${r.domain || '-'} · 版本：${r.id || '-'}<br/>
          最近更新：${formatTime(r.updated_at)}
        </div>
      `;

      const mid = document.createElement('div');
      const gate = badgeGate(r);
      mid.innerHTML = `
        <div style="margin-bottom:4px;">
          <span class="${gate.cls}">
            <span class="badge-label">Gate：</span>${gate.label}
          </span>
          <span class="badge">
            <span class="badge-label">Score：</span>
            <span class="${scoreClass(r)}">${formatScore(r)}</span>
          </span>
        </div>
        <div class="card-links">
          <span>Law: ${r.law_file || '-'}</span><br/>
          <span>QSPEC: ${r.qspec_file || '-'}</span><br/>
          <span>QEVR: ${r.qevr_file || '-'}</span>
        </div>
      `;

      const actions = document.createElement('div');
      actions.className = 'card-actions';

      const btnView = document.createElement('button');
      btnView.className = 'btn btn-secondary';
      btnView.textContent = '查看 HTML 报告';
      btnView.onclick = () => openReportModal(r);

      const btnUpload = document.createElement('button');
      btnUpload.className = 'btn btn-ghost';
      btnUpload.textContent = '上传新草案（预留接口）';
      btnUpload.onclick = () => {
        alert('上传接口会对接你的私有 API，这里只是预留按钮。');
      };

      actions.appendChild(btnView);
      actions.appendChild(btnUpload);

      card.appendChild(left);
      card.appendChild(mid);
      card.appendChild(actions);

      list.appendChild(card);
    });
  }

  function applyFilter() {
    const domain = document.getElementById('filter-domain').value.trim().toUpperCase();
    const gate = document.getElementById('filter-gate').value;
    const minScoreStr = document.getElementById('filter-min-score').value.trim();
    const minScore = minScoreStr ? parseFloat(minScoreStr) : 0;

    state.filtered = state.allReports.filter((r) => {
      if (domain && !(r.domain || '').toUpperCase().includes(domain)) return false;
      if (gate === 'pass' && r.gate_status !== 'pass') return false;
      if (gate === 'fail' && r.gate_status !== 'fail') return false;
      if (typeof r.overall_score === 'number' && r.overall_score < minScore) return false;
      return true;
    });

    renderList();
  }

  function resetFilterUI() {
    document.getElementById('filter-domain').value = '';
    document.getElementById('filter-gate').value = 'all';
    document.getElementById('filter-min-score').value = '0.90';
  }

  function openReportModal(report) {
    const backdrop = document.getElementById('report-modal-backdrop');
    const iframe = document.getElementById('report-iframe');
    const titleEl = document.getElementById('modal-title');
    const subEl = document.getElementById('modal-sub');

    titleEl.textContent = report.title || 'HTML 报告预览';
    subEl.textContent = 'Law / QSPEC / QEVR / Gate 演化版本：' + (report.id || '');

    // 关键点：使用相对路径，确保在 GitHub Pages 子路径下也能打开
    iframe.src = report.report_html ? ('./' + report.report_html.replace(/^\.\//, '')) : 'about:blank';

    backdrop.classList.add('modal--open');
  }

  function closeModal() {
    const backdrop = document.getElementById('report-modal-backdrop');
    const iframe = document.getElementById('report-iframe');
    iframe.src = 'about:blank';
    backdrop.classList.remove('modal--open');
  }

  document.getElementById('btn-apply-filter').addEventListener('click', () => {
    resetFilterUI();
    applyFilter();
  });

  document.getElementById('modal-close').addEventListener('click', closeModal);
  document.getElementById('report-modal-backdrop').addEventListener('click', (e) => {
    if (e.target.id === 'report-modal-backdrop') closeModal();
  });

  // 初始化：加载 JSON
  fetch('./data/reports.json')
    .then((res) => res.json())
    .then((data) => {
      state.allReports = Array.isArray(data) ? data : [];
      state.filtered = state.allReports.slice();
      renderList();
    })
    .catch((err) => {
      console.error('加载 reports.json 失败', err);
      const list = document.getElementById('report-list');
      list.innerHTML = '<div class="empty">加载报告列表失败，请检查 data/reports.json 是否存在。</div>';
    });
</script>
</body>
</html>
