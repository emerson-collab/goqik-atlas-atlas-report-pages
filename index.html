<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>GoQik Atlas · 标准演化报告中心</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system,BlinkMacSystemFont,"SF Pro Text","Helvetica Neue",Arial,"PingFang SC","Microsoft YaHei",sans-serif;
      background: #020617;
      color: #e5e7eb;
    }
    .app-shell {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    header {
      padding: 16px 32px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid #1f2937;
      background: radial-gradient(circle at top left,#0f172a,#020617);
    }
    .brand {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 18px;
      font-weight: 600;
    }
    .brand-pill {
      padding: 6px 14px;
      border-radius: 999px;
      background: #0ea5e9;
      color: #0b1120;
      font-weight: 700;
      box-shadow: 0 0 25px rgba(56,189,248,.65);
    }
    .brand-sub {
      font-size: 18px;
      color: #e5e7eb;
    }
    .nav-tabs {
      display: flex;
      gap: 8px;
      font-size: 14px;
    }
    .nav-tab {
      padding: 6px 14px;
      border-radius: 999px;
      border: 1px solid #1f2937;
      color: #9ca3af;
      background: rgba(15,23,42,.8);
    }
    .nav-tab.active {
      background: #0ea5e9;
      color: #0b1120;
      border-color: #38bdf8;
    }

    main {
      flex: 1;
      padding: 24px 32px 32px;
      display: flex;
      gap: 24px;
    }

    .panel {
      background: radial-gradient(circle at top,#020617,#020617);
      border-radius: 24px;
      border: 1px solid #1f2937;
      padding: 20px 22px;
      box-shadow:
        0 18px 40px rgba(15,23,42,.95),
        0 0 0 1px rgba(148,163,184,.04);
    }

    .panel-left {
      width: 320px;
      flex-shrink: 0;
      display: flex;
      flex-direction: column;
      gap: 18px;
    }

    .panel-right {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .section-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 12px;
    }

    .filter-group {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 4px;
    }

    label {
      font-size: 13px;
      color: #9ca3af;
    }

    input[type="text"],
    input[type="number"],
    select {
      width: 100%;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid #1f2937;
      background: #020617;
      color: #e5e7eb;
      font-size: 13px;
      outline: none;
    }
    input[type="text"]:focus,
    input[type="number"]:focus,
    select:focus {
      border-color: #38bdf8;
      box-shadow: 0 0 0 1px rgba(56,189,248,.4);
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 9px 18px;
      border-radius: 999px;
      border: 1px solid transparent;
      font-size: 14px;
      cursor: pointer;
      transition: all .16s ease-out;
      white-space: nowrap;
      user-select: none;
    }
    .btn-primary {
      background: linear-gradient(90deg,#22c55e,#14b8a6);
      color: #022c22;
      font-weight: 600;
      box-shadow: 0 14px 30px rgba(34,197,94,.45);
    }
    .btn-primary:hover {
      filter: brightness(1.05);
      transform: translateY(-1px);
      box-shadow: 0 18px 38px rgba(34,197,94,.6);
    }

    .btn-ghost {
      background: transparent;
      color: #e5e7eb;
      border-color: #1f2937;
    }
    .btn-ghost:hover {
      background: rgba(15,23,42,.9);
      border-color: #4b5563;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 3px 10px;
      border-radius: 999px;
      font-size: 12px;
      border: 1px solid transparent;
    }
    .badge-muted {
      border-color: #1f2937;
      color: #9ca3af;
      background: rgba(15,23,42,.9);
    }
    .badge-danger {
      border-color: rgba(248,113,113,.5);
      color: #fecaca;
      background: rgba(153,27,27,.8);
    }
    .badge-success {
      border-color: rgba(34,197,94,.5);
      color: #bbf7d0;
      background: rgba(22,101,52,.8);
    }

    .version-card {
      border-radius: 20px;
      border: 1px solid #1f2937;
      background: radial-gradient(circle at 0 0,rgba(56,189,248,.06),#020617);
      padding: 18px 18px 16px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .version-header-line {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }
    .version-title {
      font-size: 17px;
      font-weight: 600;
      color: #f9fafb;
    }
    .version-meta-row {
      display: flex;
      gap: 12px;
      font-size: 13px;
      color: #9ca3af;
      flex-wrap: wrap;
    }
    .version-source-row {
      margin-top: 4px;
      font-size: 12px;
      color: #9ca3af;
      line-height: 1.6;
    }
    .version-source-row span {
      display: inline-block;
      margin-right: 12px;
    }
    .version-actions {
      margin-top: 10px;
      display: flex;
      justify-content: flex-end;
      gap: 8px;
    }

    .explain-text {
      font-size: 13px;
      color: #9ca3af;
      line-height: 1.6;
    }

    .score-highlight {
      color: #f97316;
      font-weight: 600;
    }

    dialog::backdrop {
      background: rgba(15,23,42,.85);
      backdrop-filter: blur(6px);
    }
    dialog {
      border: none;
      border-radius: 18px;
      background: #020617;
      color: #e5e7eb;
      padding: 0;
      max-width: 1080px;
      width: 90vw;
      height: 80vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      box-shadow: 0 25px 60px rgba(15,23,42,1);
    }
    .dialog-header {
      padding: 14px 18px;
      border-bottom: 1px solid #1f2937;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      background: radial-gradient(circle at top left,#0f172a,#020617);
    }
    .dialog-header h3 {
      font-size: 15px;
    }
    .dialog-body {
      flex: 1;
      border: none;
    }
    .dialog-body iframe {
      width: 100%;
      height: 100%;
      border: none;
      background: #020617;
    }

    @media (max-width: 960px) {
      main { flex-direction: column; }
      .panel-left { width: 100%; }
    }
  </style>
</head>
<body>
<div class="app-shell">
  <header>
    <div class="brand">
      <div class="brand-pill">GoQik Atlas</div>
      <div class="brand-sub">标准演化报告中心</div>
    </div>
    <div class="nav-tabs">
      <div class="nav-tab active">B-layer QSPEC · Law · QEVR · Gate</div>
      <div class="nav-tab">B-layer 自演化 · 只读观测</div>
    </div>
  </header>

  <main>
    <!-- 左侧：过滤器 -->
    <aside class="panel panel-left">
      <div>
        <div class="section-title">过滤器</div>
        <div class="filter-group">
          <div>
            <label for="domainInput">域 / 标准：</label>
            <input id="domainInput" type="text" placeholder="例如：SS.LAW.NAMR" />
          </div>

          <div>
            <label for="gateSelect">Gate 状态：</label>
            <select id="gateSelect">
              <option value="all">全部</option>
              <option value="pass">仅通过</option>
              <option value="fail">仅未通过</option>
            </select>
          </div>

          <div>
            <label for="minScoreInput">最小得分：</label>
            <input
              id="minScoreInput"
              type="number"
              min="0"
              max="1"
              step="0.01"
              value="0.90"
            />
          </div>

          <button id="resetFilterBtn" class="btn btn-primary">重置过滤</button>
        </div>
      </div>

      <div>
        <div class="section-title" style="margin-bottom:8px;">说明</div>
        <p class="explain-text">
          本页面仅展示 <strong>机读规则演化结果</strong> 的摘要。<br />
          具体细节请点击每条记录右侧的「查看 HTML 报告」。
        </p>
      </div>
    </aside>

    <!-- 右侧：演化版本列表 -->
    <section class="panel panel-right">
      <div class="section-title">演化版本一览</div>
      <div id="versionList">
        <!-- 由脚本填充 -->
      </div>
    </section>
  </main>

  <!-- HTML 报告预览弹窗 -->
  <dialog id="htmlDialog">
    <div class="dialog-header">
      <h3 id="htmlDialogTitle">HTML 报告预览</h3>
      <button class="btn btn-ghost" onclick="closeHtmlDialog()">关闭</button>
    </div>
    <div class="dialog-body">
      <iframe id="htmlDialogFrame" src=""></iframe>
    </div>
  </dialog>
</div>

<script>
  const REPORTS_JSON_URL = 'data/reports.json';

  let allReports = [];
  let filteredReports = [];

  const els = {
    domainInput: document.getElementById('domainInput'),
    gateSelect: document.getElementById('gateSelect'),
    minScoreInput: document.getElementById('minScoreInput'),
    resetFilterBtn: document.getElementById('resetFilterBtn'),
    versionList: document.getElementById('versionList'),
    htmlDialog: document.getElementById('htmlDialog'),
    htmlDialogTitle: document.getElementById('htmlDialogTitle'),
    htmlDialogFrame: document.getElementById('htmlDialogFrame'),
  };

  async function loadReports() {
    try {
      const resp = await fetch(REPORTS_JSON_URL + '?_=' + Date.now());
      if (!resp.ok) throw new Error('HTTP ' + resp.status);
      const data = await resp.json();
      if (!Array.isArray(data)) throw new Error('invalid JSON');
      allReports = data;
      applyFilters();
    } catch (err) {
      console.error('Failed to load reports.json:', err);
      els.versionList.innerHTML =
        '<p class="explain-text">加载 reports.json 失败，请确认文件已通过同步工作流生成。</p>';
    }
  }

  function getFilters() {
    const domain = (els.domainInput.value || '').trim();
    const gate = els.gateSelect.value;

    let minScore = parseFloat(els.minScoreInput.value);
    if (isNaN(minScore)) minScore = 0;

    return { domain, gate, minScore };
  }

  function applyFilters() {
    const { domain, gate, minScore } = getFilters();

    filteredReports = allReports.filter((r) => {
      // 域 / 标准过滤（前缀匹配即可）
      if (domain && !(r.domain || '').toUpperCase().startsWith(domain.toUpperCase())) {
        return false;
      }

      // Gate 过滤
      if (gate === 'pass' && r.gate_status !== 'pass') return false;
      if (gate === 'fail' && r.gate_status !== 'fail') return false;

      // 分数过滤
      const score = Number(r.overall_score ?? 0);
      if (score < minScore) return false;

      return true;
    });

    renderList();
  }

  function renderList() {
    const list = els.versionList;
    if (!filteredReports.length) {
      list.innerHTML =
        '<p class="explain-text">当前过滤条件下没有可展示的演化记录。</p>';
      return;
    }

    const html = filteredReports
      .map((r) => {
        const gateBadges = r.gate_status === 'pass'
          ? '<span class="badge badge-success">Gate：已通过</span>'
          : '<span class="badge badge-danger">Gate：未通过</span>';

        const score = (r.overall_score ?? 0).toFixed(2);
        const threshold = (r.threshold ?? 0).toFixed(2);

        return `
          <div class="version-card">
            <div class="version-header-line">
              <div class="version-title">${r.title || '未命名演化版本'}</div>
              <div style="display:flex;gap:8px;align-items:center;">
                ${gateBadges}
                <span class="badge badge-muted">
                  Score：<span class="score-highlight">${score}</span> / ${threshold}
                </span>
              </div>
            </div>

            <div class="version-meta-row">
              <span>域：${r.domain || '-'}</span>
              <span>版本：${r.id || '-'}</span>
              <span>最近更新：${r.updated_at || '-'}</span>
            </div>

            <div class="version-source-row">
              <span><strong>Law:</strong> ${r.law_file || '-'}</span>
              <span><strong>QSPEC:</strong> ${r.qspec_file || '-'}</span>
              <span><strong>QEVR:</strong> ${r.qevr_file || '-'}</span>
            </div>

            <div class="version-actions">
              <button
                class="btn btn-ghost"
                onclick="handleUploadDraft('${encodeURIComponent(
                  r.domain || ''
                )}')"
              >
                上传新草案（预留接口）
              </button>

              <button
                class="btn btn-primary"
                onclick="openHtmlReport('${encodeURIComponent(
                  r.report_html || ''
                )}','${r.title || ''}')"
              >
                查看 HTML 报告
              </button>
            </div>
          </div>
        `;
      })
      .join('\n');

    list.innerHTML = html;
  }

  // 查看 HTML 报告：用 dialog + iframe 打开
  function openHtmlReport(reportPathEncoded, title) {
    const reportPath = decodeURIComponent(reportPathEncoded || '');
    if (!reportPath) {
      alert('当前记录没有配置 report_html 路径。');
      return;
    }
    els.htmlDialogTitle.textContent = title || 'HTML 报告预览';
    els.htmlDialogFrame.src = reportPath;
    els.htmlDialog.showModal();
  }

  function closeHtmlDialog() {
    els.htmlDialog.close();
    els.htmlDialogFrame.src = 'about:blank';
  }

  // 上传新草案入口：跳转到中心仓库 SS/LAW/ss 上传页
  function handleUploadDraft(domainEncoded) {
    const domain = decodeURIComponent(domainEncoded || '');
    const uploadUrl =
      'https://github.com/goqik-atlas/q-ss-b-layer-std-center/upload/main/SS/LAW/ss';

    const msg =
      '上传接口会把草案落到中心仓库 SS/LAW/ss 目录。\n' +
      '提交 Commit 后，GitHub Actions 会自动：\n' +
      '1）用 deepseek-chat 自演化 3 轮；\n' +
      '2）若分数不足，再用 deepseek-reasoner 追加最多 2 轮；\n' +
      '3）无论是否过 Gate，都会生成演化版法规 + QSPEC + QEVR + HTML 报告，并同步回本页面。';

    alert(msg);
    window.open(uploadUrl, '_blank');
  }

  // 绑定事件
  els.domainInput.addEventListener('input', applyFilters);
  els.gateSelect.addEventListener('change', applyFilters);
  els.minScoreInput.addEventListener('input', applyFilters);
  els.resetFilterBtn.addEventListener('click', () => {
    els.domainInput.value = '';
    els.gateSelect.value = 'all';
    els.minScoreInput.value = '0.90';
    applyFilters();
  });

  loadReports();
</script>
</body>
</html>
